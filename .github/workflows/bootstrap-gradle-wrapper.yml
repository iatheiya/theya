name: Bootstrap Gradle Wrapper and Commit

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

env:
  GRADLE_VERSION: "9.2.1"

permissions:
  contents: write

jobs:
  bootstrap-wrapper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Ensure gradle/wrapper dir exists
        run: mkdir -p gradle/wrapper

      - name: Download Gradle distribution and extract gradle-wrapper.jar
        run: |
          set -euo pipefail
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading gradle-${GRADLE_VERSION}..."
            curl -sSLo gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
            unzip -q gradle.zip
            cp "gradle-${GRADLE_VERSION}/lib/gradle-wrapper.jar" gradle/wrapper/gradle-wrapper.jar
            rm -rf "gradle-${GRADLE_VERSION}" gradle.zip
            echo "gradle-wrapper.jar installed"
          else
            echo "gradle-wrapper.jar already exists"
          fi

      - name: Create gradlew
        run: |
          set -euo pipefail
          if [ ! -f ./gradlew ]; then
            cat > ./gradlew << 'SH'
#!/usr/bin/env sh
set -e
DIRNAME="$(cd "$(dirname "$0")" && pwd)"
GRADLE_WRAPPER_JAR="$DIRNAME/gradle/wrapper/gradle-wrapper.jar"
if [ ! -f "$GRADLE_WRAPPER_JAR" ]; then
  echo "ERROR: gradle-wrapper.jar missing"
  exit 1
fi
exec java -jar "$GRADLE_WRAPPER_JAR" "$@"
SH
            chmod +x ./gradlew
            echo "Created gradlew"
          fi

      - name: Create gradlew.bat
        run: |
          set -euo pipefail
          if [ ! -f ./gradlew.bat ]; then
            cat > ./gradlew.bat << 'BAT'
@echo off
setlocal
set SCRIPT_DIR=%~dp0
set GRADLE_WRAPPER_JAR=%SCRIPT_DIR%gradlewrappergradle-wrapper.jar
if not exist "%GRADLE_WRAPPER_JAR%" (
  echo ERROR: gradle-wrapper.jar missing
  exit /b 1
)
java -jar "%GRADLE_WRAPPER_JAR%" %*
BAT
            echo "Created gradlew.bat"
          fi

      - name: Create settings.gradle.kts
        run: |
          set -euo pipefail
          if [ ! -f ./settings.gradle.kts ]; then
            cat > settings.gradle.kts << 'KTS'
pluginManagement {
  includeBuild("build-logic")
  repositories {
    google()
    mavenCentral()
    gradlePluginPortal()
  }
}
dependencyResolutionManagement {
  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
  repositories {
    google()
    mavenCentral()
  }
}
rootProject.name = "Theya"
include(":app")
include(":modules:system:glue-jni")
include(":modules:core:common")
include(":modules:core:datastore")
include(":modules:core:rust-sdk")
include(":modules:core:api")
include(":modules:core:models")
include(":modules:core:usecases")
include(":modules:core:network")
include(":modules:features:dashboard")
include(":modules:features:terminal")
include(":modules:features:bridge-explorer")
include(":modules:features:shell-setup")
include(":modules:runtime:session-service")
KTS
            echo "Created settings.gradle.kts"
          fi

      - name: Package wrapper files as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gradle-wrapper-files
          path: |
            gradlew
            gradlew.bat
            gradle/wrapper/gradle-wrapper.jar
            settings.gradle.kts

      - name: Show generated files
        run: |
          echo "Generated files:"
          ls -la gradlew gradlew.bat gradle/wrapper/gradle-wrapper.jar settings.gradle.kts || true
          echo "Download artifacts from Actions tab to use these files"