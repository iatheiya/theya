name: Bootstrap Gradle Wrapper
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: {}

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle (needed for fallback generation)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.2.1'

      - name: Create gradle wrapper directory
        run: mkdir -p gradle/wrapper

      - name: Ensure gradle-wrapper.jar (download or generate fallback)
        run: |
          set -euo pipefail
          mkdir -p gradle/wrapper
          echo "Trying to download gradle-9.2.1-wrapper.jar from services.gradle.org..."
          if curl -fsSL -o gradle/wrapper/gradle-wrapper.jar https://services.gradle.org/distributions/gradle-9.2.1-wrapper.jar; then
            echo "Downloaded gradle-wrapper.jar from services.gradle.org."
          else
            echo "Download failed, attempting to generate wrapper using Gradle CLI..."
            gradle wrapper --gradle-version 9.2.1 --no-daemon || {
              echo "gradle wrapper failed â€” creating minimal wrapper jar using published wrapper JAR location as last resort"
              if curl -fsSL -o gradle/wrapper/gradle-wrapper.jar https://services.gradle.org/distributions/gradle-wrapper.jar; then
                echo "Downloaded fallback gradle-wrapper.jar"
              else
                echo "All attempts failed. Exiting with non-zero to make failure visible."
                exit 1
              fi
            }
          fi
          ls -l gradle/wrapper || true

      - name: Create gradle-wrapper.properties
        run: |
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties <<'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-9.2.1-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
          ls -l gradle/wrapper/gradle-wrapper.properties

      - name: Ensure gradlew (UNIX)
        run: |
          if [ ! -f gradlew ]; then
            cat > gradlew <<'EOF'
#!/usr/bin/env sh
set -e
DIR="$(cd "$(dirname "$0")" && pwd)"
java -jar "$DIR/gradle/wrapper/gradle-wrapper.jar" "$@"
EOF
            chmod +x gradlew
          fi
          ls -l gradlew

      - name: Ensure gradlew.bat (Windows)
        run: |
          if [ ! -f gradlew.bat ]; then
            cat > gradlew.bat <<'EOF'
@echo off
setlocal
set DIR=%~dp0
java -jar "%DIR%gradle\wrapper\gradle-wrapper.jar" %*
endlocal
EOF
          fi
          ls -l gradlew.bat

      - name: Create settings.gradle.kts if missing
        run: |
          if [ ! -f settings.gradle.kts ]; then
            cat > settings.gradle.kts <<'EOF'
rootProject.name = "Theya"
include(":app")
EOF
          fi
          ls -l settings.gradle.kts

      - name: Upload gradle wrapper files
        uses: actions/upload-artifact@v4
        with:
          name: gradle-wrapper-files
          path: |
            gradlew
            gradlew.bat
            gradle/wrapper/**
            settings.gradle.kts