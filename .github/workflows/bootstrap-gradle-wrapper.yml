name: Bootstrap Gradle Wrapper and Commit

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

env:
  GRADLE_VERSION: "9.2.1"

permissions:
  contents: write

jobs:
  bootstrap-wrapper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (allow pushing)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Ensure gradle/wrapper dir exists
        run: |
          mkdir -p gradle/wrapper

      - name: Download Gradle distribution and extract gradle-wrapper.jar (if missing)
        run: |
          set -euo pipefail
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading gradle-${GRADLE_VERSION}..."
            curl -sSLo gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
            unzip -q gradle.zip
            if [ -f "gradle-${GRADLE_VERSION}/lib/gradle-wrapper.jar" ]; then
              cp "gradle-${GRADLE_VERSION}/lib/gradle-wrapper.jar" gradle/wrapper/gradle-wrapper.jar
              echo "gradle-wrapper.jar installed to gradle/wrapper/"
            else
              echo "ERROR: gradle-wrapper.jar not found inside distribution." >&2
              ls -la "gradle-${GRADLE_VERSION}" || true
              rm -f gradle.zip || true
              exit 1
            fi
            rm -rf "gradle-${GRADLE_VERSION}" gradle.zip
          else
            echo "gradle/wrapper/gradle-wrapper.jar already exists; skipping download."
          fi

      - name: Create gradlew (if missing)
        run: |
          set -euo pipefail
          if [ ! -f ./gradlew ]; then
            cat > ./gradlew <<'SH'
#!/usr/bin/env sh
set -e
DIRNAME="$(cd "$(dirname "$0")" && pwd)"
GRADLE_WRAPPER_JAR="$DIRNAME/gradle/wrapper/gradle-wrapper.jar"
if [ ! -f "$GRADLE_WRAPPER_JAR" ]; then
  echo "ERROR: gradle-wrapper.jar is missing at $GRADLE_WRAPPER_JAR"
  echo "Please run: gradle wrapper --gradle-version 9.2.1"
  exit 1
fi
exec java -jar "$GRADLE_WRAPPER_JAR" "$@"
SH
            chmod +x ./gradlew
            echo "Created ./gradlew"
          else
            echo "./gradlew already exists; skipping"
          fi

      - name: Create gradlew.bat (if missing)
        run: |
          set -euo pipefail
          if [ ! -f ./gradlew.bat ]; then
            cat > ./gradlew.bat <<'BAT'
@echo off
setlocal
set SCRIPT_DIR=%~dp0
set GRADLE_WRAPPER_JAR=%SCRIPT_DIR%gradlewrappergradle-wrapper.jar
if not exist "%GRADLE_WRAPPER_JAR%" (
  echo ERROR: gradle-wrapper.jar is missing at %GRADLE_WRAPPER_JAR%
  echo Run: gradle wrapper --gradle-version 9.2.1
  exit /b 1
)
java -jar "%GRADLE_WRAPPER_JAR%" %*
BAT
            echo "Created ./gradlew.bat"
          else
            echo "./gradlew.bat already exists; skipping"
          fi

      - name: Create minimal settings.gradle.kts if missing
        run: |
          set -euo pipefail
          if [ ! -f ./settings.gradle.kts ]; then
            cat > settings.gradle.kts <<'KTS'
pluginManagement {
  includeBuild("build-logic")
  repositories {
    google()
    mavenCentral()
    gradlePluginPortal()
  }
}

dependencyResolutionManagement {
  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
  repositories {
    google()
    mavenCentral()
  }
}

rootProject.name = "Theya"

include(":app")
include(":modules:system:glue-jni")

include(":modules:core:common")
include(":modules:core:datastore")
include(":modules:core:rust-sdk")
include(":modules:core:api")
include(":modules:core:models")
include(":modules:core:usecases")
include(":modules:core:network")

include(":modules:features:dashboard")
include(":modules:features:terminal")
include(":modules:features:bridge-explorer")
include(":modules:features:shell-setup")

include(":modules:runtime:session-service")
KTS
            echo "Created settings.gradle.kts"
          else
            echo "settings.gradle.kts already exists; skipping"
          fi

      - name: Show status (debug)
        run: |
          echo "Files in repo root (preview):"
          ls -la | sed -n '1,200p'
          echo ""
          echo "gradle/wrapper contents:"
          ls -la gradle/wrapper || true

      - name: Commit and push wrapper files (if any changes)
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          set -euo pipefail
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          if [ -n "${GITHUB_HEAD_REF:-}" ]; then
            BRANCH="$GITHUB_HEAD_REF"
          else
            BRANCH="${GITHUB_REF#refs/heads/}"
          fi

          echo "Target branch for push: $BRANCH"

          git add gradlew gradlew.bat gradle/wrapper/gradle-wrapper.jar settings.gradle.kts || true

          if git diff --staged --quiet; then
            echo "No changes to commit. Nothing to push."
            exit 0
          fi

          git commit -m "chore: add Gradle wrapper (gradlew, gradlew.bat, gradle-wrapper.jar) and settings if missing" || true

          if git push origin "HEAD:$BRANCH"; then
            echo "Successfully pushed Gradle wrapper files to branch $BRANCH"
          else
            echo "Failed to push changes to branch $BRANCH. This may be due to branch protection rules."
            echo "If push is blocked, create a PR manually with these changes or adjust protection temporarily."
            exit 1
          fi

      - name: Final info
        run: |
          echo "Bootstrap job finished."